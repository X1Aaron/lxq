#!/bin/bash

update() {
  cd /opt/lxq/
  git fetch --all # don't we need the git url here?
  git reset --hard origin/master
  chmod a+x lxq
}

create_container() {
  local CONTAINER_LOCAL_IP="" # this needs to be a local variable otherwise it'll end up with all the ips for some reason
  
  if [[ -n $1 ]] # check if the script has a parameter
  then
    local CONTAINER_NAME=$1 # set the container-name to the first parameter
    lxc launch images:ubuntu/18.04 $CONTAINER_NAME > /dev/null 2>&1 # launch the container with said name
  else
    local CONTAINER_NAME=$(lxc launch images:ubuntu/18.04 | awk '/name/ {print $4}') # this is kinda cool, you can run the command to make the container inside the command to set the variable
  fi
  
  echo "Container name:" $CONTAINER_NAME
 
  until [[ -n "$CONTAINER_LOCAL_IP" ]] # loop until the container has an ip address
  do
    #echo $CONTAINER_NAME #was using this for debugging
    sleep .1
    local CONTAINER_LOCAL_IP=$(lxc list $CONTAINER_NAME -c 4 --format csv | awk '{print $1}')
  done
  
  echo "IP Address:" $CONTAINER_LOCAL_IP
  echo "Updating" $CONTAINER_NAME
  lxc exec $CONTAINER_NAME -- apt-get update > /dev/null 2>&1
  lxc exec $CONTAINER_NAME -- apt-get upgrade -y > /dev/null 2>&1
  echo $CONTAINER_NAME "Finished"
}

nextcloud() {
  /opt/lxq/apps/nextcloud/nextcloud-install.sh #TODO move contents of script into this function
}

rocketchat() {
  /opt/lxq/apps/nextcloud/rocketchat-install.sh #TODO move contents of script into this function
}

init() { #TODO comment this code, and figure out a way to only do this if it's running for the first time. Maybe test for a hidden file?
  update
  echo "Allowing SSH and Enabling Firewall..."
  ufw allow ssh
  ufw --force enable
  echo "Updating System..."
  apt-get update
  apt-get upgrade -y
  echo "Installing Packages..."
  echo iptables-persistent iptables-persistent/autosave_v4 boolean true | sudo debconf-set-selections
  echo iptables-persistent iptables-persistent/autosave_v6 boolean true | sudo debconf-set-selections
  apt-get install zfsutils-linux iptables-persistent snapd netdata -y
  echo "Removing LXD Packages..."
  apt-get remove --purge lxd lxd-client liblxc1 lxcfs -y
  apt-get autoremove -y
  echo "Installing LXD via Snap..."
  snap install lxd
  echo "Updating PATH..."
  export PATH=$PATH:/snap/bin
  echo "Configuing LXD..."
  cat /opt/lxq/preseed | lxd init --preseed
  echo LXD Setup Complete!
  echo
  
  create_container nginx
  echo "Installing Packages..."
  lxc exec nginx -- apt-get install nginx software-properties-common python-certbot-nginx -y
  echo

  echo "Getting your public IPv4 address..."
  PUBLIC_IP=`curl -4 ifconfig.co`
  echo
  echo "Your Public IP is" $PUBLIC_IP
  echo
  echo "Updating iptables to forward 80/443 to nginx Container"
  echo
  iptables -t nat -I PREROUTING -i eth0 -p TCP -d $PUBLIC_IP --dport 80 -j DNAT --to-destination $IP:80
  iptables -t nat -I PREROUTING -i eth0 -p TCP -d $PUBLIC_IP --dport 443 -j DNAT --to-destination $IP:443
  netfilter-persistent save
  echo
  echo "Here are your current PREROUTING Rules"
  iptables -t nat -L PREROUTING
  echo "Setup Complete!"
  echo
}

menu() {
  echo
  echo "Welcome to LXQ"
  echo
  echo "Please select a command"
  echo "1. Update"
  echo "2. Create new container" #this may just point to lxd reference, if user doesn't want ubuntu18.04 container
  echo "3. Install Nextcloud"
  #etc
  echo -n "Enter a number:"
  read USER_INPUT
  
  case "$USER_INPUT" in
  1) update
    ;;
  2) create_container
    ;;
  3) nextcloud
    ;;
  *) echo "Invalid input"
    ;;
  esac
}

$1
